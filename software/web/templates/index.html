<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>Robot Arm Mahjong</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>

<!-- ===== Top Bar ===== -->
<div class="topbar">
  <div class="topbar-title">🀄 Robot Arm Mahjong</div>
  <div class="topbar-center">
    <button class="mode-btn active" id="btn-play" onclick="switchMode('play')">🎮 对局</button>
    <button class="mode-btn" id="btn-nav" onclick="switchMode('nav')">📊 导航</button>
  </div>
  <div class="topbar-status">
    <span class="dot" id="dot"></span>
    <span id="status-label">连接中...</span>
  </div>
</div>

<!-- ===================== PLAY MODE ===================== -->
<div class="mode-screen" id="screen-play">

  <!-- Camera strip (OpenClaw eyes) -->
  <div class="camera-strip">
    <div class="camera-box">
      <video id="camera-feed" autoplay muted playsinline></video>
      <canvas id="camera-canvas" style="display:none"></canvas>
      <div class="camera-label">👁 OpenClaw 视角</div>
      <div class="camera-status" id="camera-status">未连接</div>
    </div>
    <div class="camera-actions">
      <button class="btn btn--sm" id="cam-btn" onclick="startCamera()">📷 开启摄像头</button>
      <button class="btn btn--sm btn--auto" id="auto-loop-btn" onclick="toggleAutoLoop()">🎯 开始自动识别</button>
      <button class="btn btn--sm btn--ghost" onclick="captureAndSend()">📸 单次截帧</button>
    </div>

    <!-- Calibration Panel -->
    <div class="calib-panel" id="calib-panel">
      <div class="calib-title">📐 视觉标定</div>
      <div class="calib-status">
        <span class="calib-chip" id="calib-white">白板</span>
        <span class="calib-chip" id="calib-one">一筒</span>
      </div>
      <div class="calib-btns">
        <button class="btn btn--sm btn--calib" onclick="calibFromCamera('white_dragon')">标定白板</button>
        <button class="btn btn--sm btn--calib" onclick="calibFromCamera('one_dot')">标定一筒</button>
      </div>
      <div class="calib-hint">对准牌后点标定 · 两个都标定后识别才准</div>
    </div>
  </div>

  <!-- Center: Avatar -->
  <div class="play-center">
    <div class="avatar-wrap">
      <!-- Scene videos: full frame, outside the circle clip -->
      <video id="avatar-video-scene-a" class="scene-video" src="/static/sceneA.mp4"
             muted playsinline preload="auto" style="display:none"></video>
      <video id="avatar-video-scene-b" class="scene-video" src="/static/sceneB.mp4"
             muted playsinline preload="auto" style="display:none"></video>
      <!-- Emoji circle: shown when no video is playing -->
      <div class="avatar-stage" id="avatar-stage">
        <img id="avatar-anim" src="/static/avatar_idle.gif" onerror="this.style.display='none'" alt="" />
        <div class="avatar-emoji-big" id="avatar-emoji-big">🤖</div>
      </div>
    </div>

    <div class="speech-bubble-big" id="speech-bubble-big">
      <span id="speech-text-big">等待指令...</span>
    </div>

    <div class="tile-result" id="tile-result">
      <span class="tile-result-label">识别到</span>
      <span class="tile-result-value" id="tile-result-value">—</span>
      <span class="tile-result-conf" id="tile-result-conf"></span>
    </div>
  </div>

  <!-- Right: Controls -->
  <div class="play-controls">
    <div class="quick-btns">
      <button class="qbtn qbtn--a" id="qbtn-a" onclick="runScene('A')">
        <span class="qbtn-icon">🃏</span>
        <span class="qbtn-label">验牌 → 扔出</span>
        <span class="qbtn-sub">Scene A</span>
      </button>
      <button class="qbtn qbtn--b" id="qbtn-b" onclick="runScene('B')">
        <span class="qbtn-icon">↩️</span>
        <span class="qbtn-label">验牌 → 退回</span>
        <span class="qbtn-sub">Scene B</span>
      </button>
    </div>

    <div class="expr-row">
      <button class="expr-btn" onclick="runExtra('tap')" title="点三点">👆</button>
      <button class="expr-btn" onclick="runExtra('nod')" title="点头">✅</button>
      <button class="expr-btn" onclick="runExtra('shake')" title="摇头">❌</button>
      <button class="expr-btn" onclick="post('/home',{})" title="回零位">🏠</button>
    </div>

    <div class="play-settings">
      <label class="setting-label">
        风格
        <select id="style">
          <option value="polite">礼貌</option>
          <option value="meme">梗</option>
        </select>
      </label>
      <label class="setting-label">
        安全
        <select id="safe">
          <option value="true">开</option>
          <option value="false">关</option>
        </select>
      </label>
    </div>

  </div>

  <!-- Bottom log strip -->
  <div class="log-strip">
    <span class="log-strip-label">日志</span>
    <pre id="log-strip-content">—</pre>
  </div>

</div><!-- /screen-play -->


<!-- ===================== NAVIGATOR MODE ===================== -->
<div class="mode-screen hidden" id="screen-nav">
<div class="layout">

  <aside class="panel-avatar">
    <div class="avatar-frame" id="avatar-frame">
      <img id="avatar-img-nav" src="/static/avatar_idle.gif" onerror="this.style.display='none'" alt="" />
      <div class="avatar-emoji" id="avatar-emoji">🤖</div>
      <div class="avatar-state-badge" id="avatar-state">待机</div>
    </div>

    <div class="speech-bubble">
      <span id="speech-text">等待指令...</span>
    </div>

    <div class="recognized-card">
      <div class="rec-label">最近识别</div>
      <div class="rec-tile" id="rec-tile">—</div>
      <div class="rec-conf" id="rec-conf"></div>
    </div>

    <div class="stats-mini">
      <div class="stat-item">
        <div class="stat-num" id="stat-total">0</div>
        <div class="stat-lbl">总局数</div>
      </div>
      <div class="stat-item">
        <div class="stat-num" id="stat-success">—</div>
        <div class="stat-lbl">成功率</div>
      </div>
      <div class="stat-item">
        <div class="stat-num" id="stat-avg">—</div>
        <div class="stat-lbl">均耗时</div>
      </div>
    </div>
  </aside>

  <main class="panel-dashboard">

    <section class="section">
      <h2 class="section-title">🎯 技能 Skills</h2>
      <div class="skill-grid">
        <div class="skill-card" onclick="switchMode('play');runScene('A')">
          <div class="skill-icon">🃏</div>
          <div class="skill-name">Scene A</div>
          <div class="skill-desc">抓牌 → 验牌 → 扔出</div>
        </div>
        <div class="skill-card" onclick="switchMode('play');runScene('B')">
          <div class="skill-icon">↩️</div>
          <div class="skill-name">Scene B</div>
          <div class="skill-desc">抓牌 → 验牌 → 退回</div>
        </div>
        <div class="skill-card skill-extra" onclick="switchMode('play');runExtra('tap')">
          <div class="skill-icon">👆</div>
          <div class="skill-name">点三点</div>
          <div class="skill-desc">末端执行器</div>
        </div>
        <div class="skill-card skill-extra" onclick="switchMode('play');runExtra('nod')">
          <div class="skill-icon">✅</div>
          <div class="skill-name">点头</div>
          <div class="skill-desc">牌没问题</div>
        </div>
        <div class="skill-card skill-extra" onclick="switchMode('play');runExtra('shake')">
          <div class="skill-icon">❌</div>
          <div class="skill-name">摇头</div>
          <div class="skill-desc">还得练啊</div>
        </div>
        <div class="skill-card skill-home" onclick="post('/home',{})">
          <div class="skill-icon">🏠</div>
          <div class="skill-name">回零位</div>
          <div class="skill-desc">Home position</div>
        </div>
      </div>
    </section>

    <section class="section section--inline">
      <h2 class="section-title">⚙️ 参数</h2>
      <div class="settings-row">
        <label class="setting-label">
          台词风格
          <select id="style-nav">
            <option value="polite">礼貌 polite</option>
            <option value="meme">梗 meme</option>
          </select>
        </label>
        <label class="setting-label">
          安全模式
          <select id="safe-nav">
            <option value="true">开 Safe</option>
            <option value="false">关 Fast</option>
          </select>
        </label>
        <button class="btn btn--danger" onclick="post('/estop',{})">🚨 ESTOP</button>
      </div>
    </section>

    <section class="section">
      <h2 class="section-title">📋 对局记录 · 复盘</h2>
      <div class="history-wrap">
        <table class="history-table">
          <thead>
            <tr><th>#</th><th>场景</th><th>结果</th><th>识别牌</th><th>耗时</th><th>风格</th></tr>
          </thead>
          <tbody id="history-body">
            <tr><td colspan="6" class="empty-row">暂无记录</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="section">
      <h2 class="section-title">🖥 日志</h2>
      <pre id="logs">—</pre>
    </section>

  </main>
</div>
</div><!-- /screen-nav -->

<script src="/static/main.js"></script>
</body>
</html>
